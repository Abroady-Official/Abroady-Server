#? í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ëŠ” developì— Direct Pushë‚˜ Mergeì‹œì—
#? CI ê³¼ì •ì„ ê±°ì¹˜ê³  EC2 ì„œë²„ì— ë°°í¬í•©ë‹ˆë‹¤.
#? ê³¼ì •ì—ì„œ ì—ëŸ¬ ë°œìƒ ì‹œ PRì´ closed ë©ë‹ˆë‹¤.
#? ìˆ˜ì • ì´í›„ ë‹¤ì‹œ PR ìš”ì²­ë°”ëë‹ˆë‹¤.

name: Deploy

on:
  push:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-18.04

    strategy:
      matrix:
        node-version: [16.15.1]
        

    steps:
        #? ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: âœ… ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v2

        #? Node ë²„ì „
      - name: âš™ï¸ ${{ matrix.node-version }} ë²„ì „ì˜ ë…¸ë“œë¡œ ì„¸íŒ…í•©ë‹ˆë‹¤.
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

        #? í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: âš™ï¸ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        working-directory: ./
        run: |
          touch .env.development
          echo "${{ secrets.ABROADY }}" >> .env.development
        
        #? ë¹Œë“œ
      - name: âœ¨ ë¹Œë“œ ê³¼ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.
        working-directory: ./
        run: |
          yarn
          yarn build

      # - name: ğŸš¨ ì‹¤íŒ¨
      #   uses: actions/github-script@0.2.0
      #   with:
      #     github-token: ${{github.token}}
      #     script: |
      #       const ref = "${{github.ref}}"
      #       const pull_number = Number(ref.split("/")[2])
      #       await github.pulls.createReview({
      #         ...context.repo,
      #         pull_number,
      #         body:"ğŸ‘‰ ì„œë²„ ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.",
      #         event: "REQUEST_CHANGES"
      #       })
      #       await github.pulls.update({
      #         ...context.repo,
      #         pull_number,
      #         state: "closed"
      #       })
      #   if: failure()

        #? ë¹Œë“œí•œ ì½”ë“œ ì••ì¶•
      - name: ğŸ“¦ ë¹Œë“œí•œ ì½”ë“œë¥¼ ì••ì¶•í•©ë‹ˆë‹¤.
        #TODO ì‹¤ì œ ë¦´ë¦¬ì¦ˆ ì´í›„ í™˜ê²½ ë³€ìˆ˜ ë³€ê²½
        run: zip -r abroady.zip ./dist ./scripts ./appspec.yml ./.env.development ./package.json ./prisma 

        #? AWS ì„¸íŒ…
      - name: ğŸŒ AWSì— ì ‘ì†í•©ë‹ˆë‹¤.
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

        #? ì••ì¶•í•œ ë¹Œë“œ ì½”ë“œ S3ì— ì—…ë¡œë“œ
      - name: ğŸ¦– S3ì— ì••ì¶•ëœ ì„œë²„ ì½”ë“œë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
        run: aws s3 cp --region ${{ secrets.AWS_REGION }} ./abroady.zip s3://abroady-build/deploy/

        #? CodeDeployë¥¼ í†µí•´ ë°°í¬
      - name: ğŸš€ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
        run: aws deploy create-deployment
          --application-name abroady-codedeploy
          --deployment-config-name CodeDeployDefault.OneAtATime
          --deployment-group-name GROUP
          --s3-location bucket=abroady-build,bundleType=zip,key=deploy/abroady.zip
